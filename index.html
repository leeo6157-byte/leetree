<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯—æ­Œé—¯å…³ - Pirate Story</title>
    <style>
        :root { --primary: #4CAF50; --secondary: #2196F3; --accent: #FF9800; --bg: #f4f7f6; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .screen { display: none; width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; text-align: center; }
        .active { display: block; }

        .preview-item { background: white; padding: 15px; margin: 10px 0; border-radius: 10px; text-align: left; border: 1px solid #eee; }
        .preview-en { color: var(--secondary); font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .preview-zh { color: #666; cursor: pointer; }

        #timer-container { width: 100%; height: 8px; background: #eee; position: fixed; top: 0; left: 0; z-index: 1000; display: none; }
        #timer-bar { height: 100%; width: 100%; background: var(--primary); transition: width 0.1s linear; }

        .difficulty-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; width: 100%; }
        .diff-btn { background: white; color: #555; border: 1px solid #ccc; font-size: 0.9rem; padding: 12px 0; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; }
        .diff-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        .card { background: white; border: 2px solid #ddd; border-radius: 8px; padding: 12px; margin: 5px; cursor: pointer; display: inline-block; transition: 0.2s; user-select: none; }
        .card.selected { border-color: var(--secondary); background: #e3f2fd; }
        .card.hidden { opacity: 0; pointer-events: none; }
        .card.correct-placed { background: #e8f5e9; border-color: var(--primary); color: #2e7d32; font-weight: bold; }
        
        .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .drop-zone { min-height: 60px; border-bottom: 2px dashed #ccc; display: flex; flex-wrap: wrap; gap: 5px; padding: 10px; margin-bottom: 15px; }
        .word-pool { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        
        button.action-btn { padding: 12px 20px; border: none; border-radius: 25px; background: var(--secondary); color: white; font-weight: bold; cursor: pointer; margin: 5px; }
        .rank-box { background: #fff; padding: 10px; border-radius: 8px; margin-top: 15px; text-align: left; font-size: 0.85rem; border: 1px solid #eee; }
    </style>
</head>
<body>

<div id="timer-container"><div id="timer-bar"></div></div>

<div id="menu-screen" class="screen active">
    <h1>ğŸ´â€â˜ ï¸ Pirate Story</h1>
    <p>1. é€‰æ‹©å°èŠ‚ (ç‚¹å‡»é¢„ä¹ è¯—å¥)</p>
    <div id="group-btns"></div>
    <p style="margin-top:20px">2. é€‰æ‹©éš¾åº¦ (æŒ‘æˆ˜æ’è¡Œæ¦œ)</p>
    <div class="difficulty-btns">
        <button class="diff-btn" id="d1" onclick="selectDiff(1)">æ‚ é—² (æ— è®¡æ—¶)</button>
        <button class="diff-btn" id="d2" onclick="selectDiff(2)">è¿›é˜¶ (åŸºç¡€)</button>
        <button class="diff-btn" id="d3" onclick="selectDiff(3)">é«˜çº§ (æŒ‘æˆ˜)</button>
        <button class="diff-btn" id="d4" onclick="selectDiff(4)">ç‹‚æš´ (æé€Ÿ)</button>
    </div>
    <div id="rank-display" class="rank-box"></div>
</div>

<div id="preview-screen" class="screen">
    <h2 id="preview-title" style="color:var(--secondary)"></h2>
    <p style="font-size: 0.9rem; color: #888;">ç‚¹è‹±æ–‡è¯»è‹±æ–‡ï¼Œç‚¹ä¸­æ–‡è¯»ä¸­æ–‡</p>
    <div id="preview-list"></div>
    <button class="action-btn" style="background:var(--primary); width:100%; margin-top:20px;" onclick="startChallenge()">å‡†å¤‡å¥½äº†ï¼Œå¼€å§‹æ¢é™©ï¼</button>
    <button class="action-btn" style="background:#999" onclick="goHome()">è¿”å›ä¸»é¡µ</button>
</div>

<div id="game-screen" class="screen">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <button class="action-btn" onclick="prevLevel()" style="background:#607d8b; padding:8px 12px; font-size:0.8rem;">â—€ ä¸Šä¸€å¥</button>
        <span id="info-display" style="font-weight:bold; font-size:0.9rem;"></span>
        <button class="action-btn" onclick="nextLevel(true)" style="background:#607d8b; padding:8px 12px; font-size:0.8rem;">ä¸‹ä¸€å¥ â–¶</button>
    </div>
    <div id="mode-display" style="color:var(--secondary); font-weight:bold; margin-bottom:10px;"></div>
    <div class="controls" style="margin-bottom:15px;">
        <button class="action-btn" onclick="speakFullEn()" style="background:var(--secondary);">ğŸ”Š æœ—è¯»å…¨å¥</button>
        <button class="action-btn" onclick="toggleTranslate()" style="background:var(--accent);">ğŸ” ç¿»è¯‘</button>
    </div>
    <div id="translate-box" style="display:none; background:#fff3e0; padding:12px; border-radius:8px; cursor:pointer; margin-bottom:15px;" onclick="speakCurrentZh()">
        <span id="hint-text"></span> (ç‚¹å‡»å‘éŸ³)
    </div>
    <div id="main-content"></div>
</div>

<script>
const storyGroups = [
    { name: "ç¬¬ä¸€èŠ‚ï¼šå¯èˆª", data: [
        { f: "Three of us afloat in the meadow by the swing", z: "æˆ‘ä»¬ä¸‰ä¸ªæ¼‚æ³Šåœ¨ç§‹åƒæ—çš„è‰åœ°ä¸Š", w: [{e:"Three of us",c:"æˆ‘ä»¬ä¸‰ä¸ª"},{e:"afloat",c:"æ¼‚æ³Š"},{e:"meadow",c:"è‰åœ°"},{e:"swing",c:"ç§‹åƒ"}]},
        { f: "Three of us aboard in the basket on the lea", z: "æˆ‘ä»¬ä¸‰ä¸ªç™»èˆ¹åœ¨æ—é—´ç©ºåœ°çš„ç¯®å­é‡Œ", w: [{e:"aboard",c:"åœ¨èˆ¹ä¸Š"},{e:"basket",c:"ç¯®å­"},{e:"lea",c:"æ—é—´ç©ºåœ°"}]},
        { f: "Winds are in the air they are blowing in the spring", z: "é£æ‹‚è¿‡å¤©é™…ï¼Œæ˜¥æ—¥é‡Œè½»è½»æ‘‡æ›³", w: [{e:"Winds",c:"é£"},{e:"air",c:"ç©ºæ°”/å¤©é™…"},{e:"blowing",c:"å¹æ‹‚"},{e:"spring",c:"æ˜¥å¤©"}]},
        { f: "And waves are on the meadow like the waves there are at sea", z: "è‰åœ°ä¸Šçš„â€œæ³¢æµªâ€èµ·ä¼ï¼Œæ°ä¼¼æµ·ä¸Šçš„æ³¢æ¶›ç¿»æ¶Œ", w: [{e:"waves",c:"æ³¢æµª"},{e:"meadow",c:"è‰åœ°"},{e:"at sea",c:"åœ¨æµ·ä¸Š"}]}
    ]},
    { name: "ç¬¬äºŒèŠ‚ï¼šæ¢é™©ç›®çš„åœ°", data: [
        { f: "Where shall we adventure today that we are afloat", z: "ä»Šæ—¥æˆ‘ä»¬æ¼‚æ³Šå››æ–¹ï¼Œè¯¥å‘ä½•å¤„æ¢é™©ï¼Ÿ", w: [{e:"adventure",c:"æ¢é™©"},{e:"today",c:"ä»Šå¤©"},{e:"afloat",c:"æ¼‚æ³Š"}]},
        { f: "Wary of the weather and steering by a star", z: "ç•™æ„ç€å¤©æ°”å˜å¹»ï¼Œè·Ÿç€æ˜Ÿè¾°æŒ‡å¼•èˆªå‘", w: [{e:"Wary",c:"ç•™æ„çš„"},{e:"weather",c:"å¤©æ°”"},{e:"steering",c:"é©¾é©¶/å¯¼èˆª"},{e:"star",c:"æ˜Ÿè¾°"}]},
        { f: "Shall it be to Africa a-steering of the boat", z: "æ˜¯é©¶å‘éæ´²å¤§é™†ï¼Œé©¾ç€å°èˆ¹ç ´æµªå‰è¡Œï¼Ÿ", w: [{e:"Africa",c:"éæ´²"},{e:"boat",c:"å°èˆ¹"}]},
        { f: "To Providence or Babylon or off to Malabar", z: "æˆ–æ˜¯å»å¾€æ™®ç½—ç»´ç™»æ–¯ã€å·´æ¯”ä¼¦ï¼Œäº¦æˆ–æ˜¯è¿œèµ´é©¬æ‹‰å·´å°”", w: [{e:"Providence",c:"æ™®ç½—ç»´ç™»æ–¯"},{e:"Babylon",c:"å·´æ¯”ä¼¦"},{e:"Malabar",c:"é©¬æ‹‰å·´å°”"}]}
    ]},
    { name: "ç¬¬ä¸‰èŠ‚ï¼šèº²é¿ç‰›ç¾¤", data: [
        { f: "Hi but here is a squadron a-rowing on the sea", z: "å—¨ï¼å¯çœ‹é‚£æµ·ä¸Šé©¶æ¥ä¸€é˜Ÿèˆ°é˜Ÿ", w: [{e:"squadron",c:"ä¸­é˜Ÿ/èˆ°é˜Ÿ"},{e:"rowing",c:"åˆ’èˆ¹"},{e:"sea",c:"å¤§æµ·"}]},
        { f: "Cattle on the meadow a-charging with a roar", z: "åŸæ˜¯è‰åœ°ä¸Šçš„ç‰›ç¾¤ï¼Œå‘¼å•¸ç€ç‹‚å¥”è€Œæ¥", w: [{e:"Cattle",c:"ç‰›ç¾¤"},{e:"charging",c:"å†²é”‹"},{e:"roar",c:"å’†å“®"}]},
        { f: "Quick and we will escape them they are as mad as they can be", z: "å¿«ï¼æˆ‘ä»¬å¾—èº²å¼€å®ƒä»¬ï¼Œå®ƒä»¬å·²ç„¶ç‹‚èºä¸å·²", w: [{e:"Quick",c:"å¿«"},{e:"escape",c:"é€ƒè„±"},{e:"mad",c:"ç–¯ç‹‚çš„"}]},
        { f: "The wicket is the harbour and the garden is the shore", z: "é‚£å°é—¨ä¾¿æ˜¯æ¸¯æ¹¾ï¼ŒèŠ±å›­å°±æ˜¯å²¸è¾¹çš„å½¼å²¸", w: [{e:"wicket",c:"å°é—¨"},{e:"harbour",c:"æ¸¯å£"},{e:"garden",c:"èŠ±å›­"},{e:"shore",c:"å²¸"}]}
    ]}
];

let curGrp = 0, curLvl = 0, diff = 1, isP2 = false;
let selEn = null, selZh = null, timer = null, totalT = 0, leftT = 0, startTime = 0;
let currentAudio = null;
const synth = window.speechSynthesis;

async function speak(text, lang) {
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    if (synth.speaking) { synth.cancel(); }
    const voice = (lang === 'en-US') ? 'en-US-GuyNeural' : 'zh-CN-XiaoxiaoNeural';
    const url = `https://api.p6p.net/api/tts?text=${encodeURIComponent(text)}&voice=${voice}`;
    try {
        currentAudio = new Audio(url);
        const playPromise = currentAudio.play();
        if (playPromise !== undefined) { await playPromise; }
    } catch (e) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = 0.95;
        synth.speak(utterance);
    }
}

function initMenu() {
    const box = document.getElementById('group-btns');
    box.innerHTML = '';
    storyGroups.forEach((g, i) => {
        const b = document.createElement('button');
        b.className = 'card'; b.style.width = "100%"; b.style.marginBottom = "10px";
        b.innerText = g.name;
        b.style.background = (curGrp === i) ? "#e3f2fd" : "#fff";
        b.onclick = () => { curGrp = i; showPreview(); };
        box.appendChild(b);
    });
    selectDiff(diff);
}

function selectDiff(d) {
    diff = d;
    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('d'+d).classList.add('active');
    updateRankDisp();
}

function updateRankDisp() {
    const rBox = document.getElementById('rank-display');
    if(diff === 1) { rBox.innerHTML = "ğŸ’¡ æ‚ é—²éš¾åº¦ä¸è®°å½•æ’è¡Œæ¦œã€‚"; return; }
    const key = `rank_g${curGrp}_d${diff}`;
    const scores = JSON.parse(localStorage.getItem(key) || "[]");
    let h = `<strong>æ’è¡Œæ¦œ (${storyGroups[curGrp].name})</strong><br>`;
    if(scores.length === 0) h += "æš‚æ— è®°å½•";
    else scores.forEach((s, i) => h += `${i+1}. ${s}s `);
    rBox.innerHTML = h;
}

function showPreview() {
    switchScreen('preview-screen');
    document.getElementById('preview-title').innerText = storyGroups[curGrp].name;
    const list = document.getElementById('preview-list');
    list.innerHTML = '';
    storyGroups[curGrp].data.forEach(item => {
        const d = document.createElement('div');
        d.className = 'preview-item';
        const enP = document.createElement('p'); enP.className='preview-en'; enP.innerText=item.f;
        enP.onclick = (e) => { e.stopPropagation(); speak(item.f, 'en-US'); };
        const zhP = document.createElement('p'); zhP.className='preview-zh'; zhP.innerText=item.z;
        zhP.onclick = (e) => { e.stopPropagation(); speak(item.z, 'zh-CN'); };
        d.append(enP, zhP);
        list.appendChild(d);
    });
}

function startChallenge() {
    curLvl = 0; isP2 = false;
    switchScreen('game-screen');
    startTime = Date.now();
    loadLevel();
}

function loadLevel() {
    const data = storyGroups[curGrp].data[curLvl];
    const box = document.getElementById('main-content');
    document.getElementById('info-display').innerText = `${curLvl + 1} / ${storyGroups[curGrp].data.length}`;
    document.getElementById('hint-text').innerText = data.z;
    document.getElementById('translate-box').style.display = 'none';
    box.innerHTML = ""; selEn = null; selZh = null;
    if (!isP2) { renderMatch(data, box); document.getElementById('mode-display').innerText = "ç¬¬ä¸€é˜¶æ®µï¼šè¯ç»„åŒ¹é…"; }
    else { renderSentence(data, box); document.getElementById('mode-display').innerText = "ç¬¬äºŒé˜¶æ®µï¼šè¯—å¥è¿˜åŸ"; }
    if(diff > 1) { document.getElementById('timer-container').style.display = 'block'; resetTimer(data.f); }
    else { document.getElementById('timer-container').style.display = 'none'; }
}

function resetTimer(sentence) {
    clearInterval(timer);
    const wc = sentence.split(' ').length;
    const config = { 2: [8, 5], 3: [6, 3.5], 4: [4, 2.5] };
    const [base, add] = config[diff];
    totalT = base + (wc * add);
    leftT = totalT;
    timer = setInterval(() => {
        leftT -= 0.1;
        document.getElementById('timer-bar').style.width = Math.max(0, (leftT/totalT)*100) + "%";
        if (leftT <= 0) { clearInterval(timer); alert("èˆªè¡Œè§¦ç¤ï¼é‡è¯•æœ¬å¥ã€‚"); isP2 = false; loadLevel(); }
    }, 100);
}

function renderMatch(data, box) {
    const grid = document.createElement('div'); grid.className = 'match-grid';
    const left = document.createElement('div'), right = document.createElement('div');
    const ens = [...data.w].sort(() => Math.random() - 0.5);
    const zhs = [...data.w].sort(() => Math.random() - 0.5);
    ens.forEach(i => left.appendChild(createMCard(i.e, 'en', i.e)));
    zhs.forEach(i => right.appendChild(createMCard(i.c, 'zh', i.e)));
    grid.append(left, right); box.appendChild(grid);
}

function createMCard(txt, lang, mid) {
    const d = document.createElement('div');
    d.className = 'card'; d.style.display = 'block'; d.innerText = txt;
    d.onclick = () => {
        speak(txt, lang === 'en' ? 'en-US' : 'zh-CN');
        if (lang === 'en') { if(selEn) selEn.classList.remove('selected'); selEn = d; }
        else { if(selZh) selZh.classList.remove('selected'); selZh = d; }
        d.classList.add('selected');
        if (selEn && selZh) {
            if (selEn.dataset.mid === selZh.dataset.mid) {
                const e=selEn, z=selZh;
                setTimeout(() => { e.classList.add('hidden'); z.classList.add('hidden'); 
                if (document.querySelectorAll('.match-grid .card:not(.hidden)').length === 0) { isP2 = true; loadLevel(); }
                }, 200);
            }
            const e=selEn, z=selZh; setTimeout(()=> { e.classList.remove('selected'); z.classList.remove('selected'); }, 400);
            selEn = null; selZh = null;
        }
    };
    d.dataset.mid = mid;
    return d;
}

function renderSentence(data, box) {
    let sIdx = 0;
    const words = data.f.split(' ');
    const drop = document.createElement('div'); drop.className = 'drop-zone';
    const pool = document.createElement('div'); pool.className = 'word-pool';
    const shuffled = [...words].sort(() => Math.random() - 0.5);
    shuffled.forEach(w => {
        const c = document.createElement('div'); c.className = 'card'; c.innerText = w;
        c.onclick = () => {
            if (w === words[sIdx]) {
                speak(w, 'en-US'); c.classList.add('hidden');
                const p = document.createElement('div'); p.className = 'card correct-placed'; p.innerText = w;
                drop.appendChild(p); sIdx++;
                if (sIdx === words.length) { clearInterval(timer); setTimeout(() => nextLevel(false), 800); }
            } else { c.style.borderColor = 'red'; setTimeout(()=>c.style.borderColor='#ddd', 500); }
        };
        pool.appendChild(c);
    });
    box.append(drop, pool);
}

function speakFullEn() { speak(storyGroups[curGrp].data[curLvl].f, 'en-US'); }
function toggleTranslate() { const box = document.getElementById('translate-box'); box.style.display = (box.style.display === 'none') ? 'block' : 'none'; }
function speakCurrentZh() { speak(storyGroups[curGrp].data[curLvl].z, 'zh-CN'); }
function nextLevel(manual) {
    if (manual) { curLvl++; isP2 = false; } else if (isP2) { curLvl++; isP2 = false; }
    if (curLvl >= storyGroups[curGrp].data.length) {
        if(diff > 1) { const finalTime = ((Date.now() - startTime)/1000).toFixed(1); saveScore(finalTime); alert(`æŠµè¾¾ç»ˆç‚¹ï¼æ€»ç”¨æ—¶ï¼š${finalTime}ç§’`); }
        else alert("æœ¬èŠ‚å®Œæˆï¼"); goHome();
    } else loadLevel();
}
function saveScore(t) { const key = `rank_g${curGrp}_d${diff}`; let s = JSON.parse(localStorage.getItem(key) || "[]"); s.push(parseFloat(t)); s.sort((a,b) => a - b); localStorage.setItem(key, JSON.stringify(s.slice(0, 5))); }
function prevLevel() { if (curLvl > 0) { curLvl--; isP2 = false; loadLevel(); } }
function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function goHome() { clearInterval(timer); switchScreen('menu-screen'); initMenu(); }

initMenu();
</script>
</body>
</html>
